#!/usr/bin/env python3
import os
import sys

def show_banner():
    print("""
 / ____|         | |    |__ \         | |    
| |        __ _  | |__     ) |  _ __  | | __ 
| |       / _` | | '_ \   / /  | '_ \ | |/ / 
| |____  | (_| | | |_) | / /_  | |_) | |   < 
 \_____|  \__,_| |_.__/ |____| | .__/  |_|\_\\
                               | |           
                               |_|           
      Code2pkg (C2P) - SDK by MurilooPr
    """)

def main():
    show_banner()
    
    # 1. LOCALIZAÇÃO (Tudo no Root)
    pasta_projetos = "projects"
    
    # 2. SELEÇÃO DO PROJETO
    projeto_alvo = input("-> Nome da pasta do seu projeto (em projects/): ").strip()
    caminho_completo = os.path.join(pasta_projetos, projeto_alvo)

    if not os.path.exists(caminho_completo):
        print(f"\n[!] Erro: Pasta '{projeto_alvo}' nao encontrada em '{pasta_projetos}/'.")
        return

    # 3. DADOS DO SFO
    print(f"\n[*] Configurando PKG para: {projeto_alvo}")
    nome_ps3 = input("-> Nome no Menu do PS3: ").strip() or projeto_alvo
    title_id = input("-> Title ID (Padrao: SKB00001): ").strip() or "SKB00001"

    # 4. COMPILAÇÃO DO MAIN.C
    arquivo_c = os.path.join(caminho_completo, "main.c")
    if not os.path.exists(arquivo_c):
        print(f"[!] Erro: Nao encontrei 'main.c' em {caminho_completo}/")
        return

    print(f"\n[*] Compilando...")
    output_elf = os.path.join(caminho_completo, "output.elf")
    
    # Compila usando clang (estando no root)
    res = os.system(f"clang -Wall -O2 {arquivo_c} -o {output_elf}")

    if res == 0:
        print("[✔] Binario ELF gerado.")
        
        # 5. CHAMADA DOS SCRIPTS NO ROOT
        # Note que não tem mais "core/" aqui
        print("[*] Gerando arquivos do sistema...")
        os.system(f"python sfo_gen.py '{nome_ps3}' {title_id} {caminho_completo}")
        os.system(f"python eboot_gen.py {output_elf} {caminho_completo}")

        # Limpeza
        if os.path.exists(output_elf):
            os.remove(output_elf)
            
        # Verificação Final
        if os.path.exists(os.path.join(caminho_completo, "EBOOT.BIN")):
            print(f"\n[✔] SUCESSO! Tudo pronto em: {caminho_completo}")
        else:
            print("\n[!] Erro: Scripts de suporte falharam ao gerar arquivos.")
    else:
        print("\n[!] Falha fatal na compilacao do codigo C.")

if __name__ == "__main__":
    main()
